import { useState, useEffect } from "react";
import { BsRobot } from "react-icons/bs";
import NeedHelpImage from './assets/NeedHelp.png';
import SendImage from './assets/Send.png';
import { IoCloseCircleSharp } from "react-icons/io5";
import LanguageDropdown from "./component/LanguageDropdown";
import { useTranslation } from "react-i18next";
import { IoIosArrowBack } from "react-icons/io";
import { FaChevronDown } from "react-icons/fa";
import { FaMicrophone } from 'react-icons/fa';
import { postAPI } from './caller/axiosUrls';
import UserDetailsForm from "./component/UserDetailsForm";
import axios from 'axios';
// import { fetchNearbyStores } from './component/FetchNearbyStores';
import Markdown from "react-markdown";
import PulseLoader from "react-spinners/PulseLoader";
import './App.css';
import 'animate.css';
import Form from "./component/Form"
import handleSubmit from "./component/Form"; // Adjust the correct path
const App = () => {
    
    const [showUserForm, setShowUserForm] = useState(false);
    const [isChatbotOpen, setIsChatbotOpen] = useState(false);
    const [isListening, setIsListening] = useState(false);
    
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.continuous =     false;
    recognition.interimResults = false;
    recognition.lang = 'en-US';
    recognition.onstart = () => {
        setIsListening(true);
    };
    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        setInput(transcript);
    };
    recognition.onend = () => {
        setIsListening(false);
    };
    const handleVoiceInput = () => {
        if (!isListening) {
            recognition.start();
        } else {
            recognition.stop();
        }
    };
    const [isFAQOpen, setIsFAQOpen] = useState(false);
    const [isHelpPageOpen, setIsHelpPageOpen] = useState(false);
    const [isChatStarted, setIsChatStarted] = useState(false);
    const { t, i18n } = useTranslation();
    const [openFAQIndex, setOpenFAQIndex] = useState(null);
    const [openHelpPageIndex, setHelpPageIndex] = useState(null);
    const [messages, setMessages] = useState([]);
    const [sender, setSender] = useState(false);
    const [input, setInput] = useState("");
    const [displayedMessages, setDisplayedMessages] = useState([]); // Messages being shown
    const [typingMessage, setTypingMessage] = useState(""); // For letter-by-letter effect
    const [isFormVisible, setFormVisible] = useState(false);
    const [formData, setFormData] = useState(null);
    const [followup, setFollowup] = useState([]);
 
   
    const handleFormCancel = () => {
        setFormVisible(false); // Close the form without submitting
        setFollowup([]);
    };
    const handleFAQClick = (index) => {
        setOpenFAQIndex(prevIndex => prevIndex === index ? null : index);
    };
    const handleHelpTabClick = (index) => {
        setHelpPageIndex(prevIndex => prevIndex === index ? null : index);
    };
   
    const botQuery = async (query) => {
        const userFormFilled = localStorage.getItem("userFormFilled");
    console.log("userform", userFormFilled)
    if (userFormFilled === null) {
      setIsChatStarted(false);
      setShowUserForm(true);
    }
        setSender(true);
        try {
            // Prepare the request body for API call
            const lang = localStorage.getItem("lang") || "en";
            const requestBody = {
                original_query_string: query,       // backend expects this
                chat_history: followup,
                language: lang              // backend expects "chat_history"
            };
            console.log("request body here", requestBody);

            // Make the API call
            const response = await postAPI(`/query`, requestBody);
            console.log("API Response:", response);

            // Normalize bot response to always be a string
            const botReply = typeof response.response.bot_response === "object"
                ? response.response.bot_response.bot_response   // if object
                : response.response.bot_response;               // if string



            // Append both the user query and the bot's response to followup history
            const updatedFollowup = [
                ...followup,
                { user_query: query, bot_response: botReply }
            ];

            // Keep only the last two interactions
            if (updatedFollowup.length > 2) {
                updatedFollowup.splice(0, updatedFollowup.length - 2);
            }

            // Update followup state
            setFollowup(updatedFollowup);

            return botReply;
        } catch (error) {
            console.error("API Error:", error);
            toast.error("Couldn't connect to chatbot! Please try later.");
        } finally {
            setSender(false);
        }
    };
    
    const handleSendMessage = async () => {
        if (sender) return;

        try {
            if (!input.trim()) return; // Prevent sending empty messages

            if (!isChatStarted) setIsChatStarted(true);

            setMessages([...messages, { text: input, sender: "user" }]);
            const userMessage = input;
            setInput(""); // Clear input field
                
                    // ðŸ”µ Default: Call botQuery for general queries
                    const answer = await botQuery(userMessage);
                    console.log(answer)
                    if (answer) {
                        setMessages([
                            ...messages,
                            { text: userMessage, sender: "user" },
                            { text: answer, sender: "bot", speaker: true }
                        ]);
                    }
                
            ;
        } catch (error) {
            setMessages([
                ...messages,
                { text: input, sender: "user" },
                { text: "Couldn't connect to chatbot! Please try later.", sender: "bot", speaker: false }
            ]);
            console.log(error.message);
        }
    };


    // FAQs for Home and Help tabs
    const homeFAQs = [
        {
            question: t("wcsdmso"),
            answer: t(
                "mspccsims"
            ),
        },
        {
            question: t("hdmseds"),
            answer: t(
                "wpdstaml"
            ),
        },
        {
            question: t("wsoaafc"),
            answer: t(
                "wovsoids"
            ),
        },
        {
            question: t("watbopwms"),
            answer: t("pwmsonbia"),
        },
    ];
    const helpFAQs = [
        {
            question: t("How do I contact customer support?"),
            answer: t(
                "You can connect with our support team using email, Toll-free number & support portal."
            ),
        },
        {
            question: t("What are your support hours?"),
            answer: t(
                "Standard support is available between 9AM to 6PM on all working days."
            ),
        },
        {
            question: t("What types of issues does your support team handle?"),
            answer: t(
                "O365, Azure & D365 related technical issues & troubleshooting support."
            ),
        },
        {
            question: t("What languages does your support team provide assistance in?"),
            answer: t(
                "We use English as a communication language for support process."
            ),
        },
        {
            question: t("What is the average turnaround time for resolving support tickets?"),
            answer: t(
                "The initial response time will 30 mins after raising support request."
            ),
        },
    ];
    useEffect(() => {
        if (isChatbotOpen) {
            const chatBody = document.querySelector(".chat-body");
            if (chatBody) {
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        }
    }, [messages, isChatbotOpen]);
    return (
        <>
            <div
                className={`fixed z-10 max-w-[350px] overflow-hidden !ease-[cubic-bezier(0.77,0,0.175,1)] !duration-[400ms] flex flex-col items-center bottom-[20px] ${isChatbotOpen
                        ? "w-11/12 left-1/2 transform -translate-x-1/2 md:left-auto md:-translate-x-0 md:right-[20px] h-[450px] rounded-[18px] border-[2px] border-[#EBECED] bg-white shadow-2xl"
                        : "justify-center right-[20px] w-[60px] h-[60px] opacity-80 cursor-pointer hover:opacity-100 rounded-[50%] bg-[#2E5BFF]"
                    }`}
            >
                {isChatbotOpen ? (
                    <>
                        {/* Header */}
                        <div className="w-full bg-[#2E5BFF] shadow-md px-5 flex justify-between items-center shadow min-h-[60px]">
                            <div className="flex gap-x-3 items-center">
                                <p className="text-white text-[16px] font-semibold">
                                    {t("M Bot")}
                                </p>
                                <BsRobot className="text-white mb-1 text-[24px]" />
                            </div>
                            <div className="flex gap-x-5 items-center">
                                <div
                                    className="cursor-pointer flex flex-col items-center justify-center"
                                    onClick={() => {
                                        setIsHelpPageOpen(true);
                                        setIsFAQOpen(false);
                                    }}
                                >
                                    <img
                                        className="w-[25%] object-contain"
                                        src={NeedHelpImage}
                                        alt="Need Help Image"
                                    />
                                    <p className="text-[10px] text-white font-medium">
                                        {t("needhelp")}
                                    </p>
                                </div>
                                <IoCloseCircleSharp
                                    onClick={() => {
                                        setIsChatbotOpen(false);
                                        setIsFAQOpen(false);
                                        setIsHelpPageOpen(false);
                                        setShowUserForm(false);
                                    }}
                                    className="cursor-pointer text-white text-[20px]"
                                />
                            </div>
                        </div>

                        {/* Tabs */}
                        <div className="rounded-b-[12px] w-full flex justify-between items-center border-b border-[#EBECED] px-[1rem] py-[0.5rem]">
                            <div className="flex items-center gap-x-[10px]">
                                <a
                                    href="https://onmeridian.com/contact-us/"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="cursor-pointer bg-[#F5F5F5] rounded-[30px] text-[13px] px-[6px] py-[1px] flex items-center justify-center"
                                >
                                    {t("contactus")}
                                </a>

                                <button
                                    onClick={() => {
                                        setIsFAQOpen(true);
                                        setIsHelpPageOpen(false);
                                    }}
                                    className="cursor-pointer bg-[#F5F5F5] rounded-[30px] text-[13px] px-[6px] py-[1px]"
                                >
                                    {t("faq")}
                                </button>
                            </div>
                            <LanguageDropdown />
                        </div>

                        {/* === User Details Form Overlay === */}
                        {showUserForm && !isChatStarted && (
                            <div className="noscroll z-30 absolute flex-col bg-white top-0 left-1/2 -translate-x-1/2 min-w-full h-full grow flex">
                                <div className="flex items-center px-5 pt-5 relative z-[10000]">
                                    <IoIosArrowBack
                                        onClick={() => setShowUserForm(false)}
                                        className="cursor-pointer text-xl"
                                    />
                                </div>

                                <div className="flex flex-col items-center px-4 py-2 w-full max-w-lg">
                                    <UserDetailsForm
                                        onFormSubmit={(data) => {
                                            console.log("Form Data:", data);
                                            localStorage.setItem("userFormFilled", "true");
                                            setShowUserForm(false);
                                            setIsChatStarted(true);
                                        }}
                                    />
                                </div>
                            </div>
                        )}

                        {/* === Main Body === */}
                        <div className="grow relative flex flex-col px-[18px]">
                            {/* FAQ Panel */}
                            <div
                                className={`noscroll !duration-600 z-30 absolute flex-col bg-white top-0 left-1/2 -translate-x-1/2 overflow-auto min-w-full ${isFAQOpen ? "h-full grow flex" : "h-0 grow-0"
                                    }`}
                            >
                                <div className="flex items-center px-5 pt-5">
                                    <IoIosArrowBack
                                        className="text-xl text-[#000000] min-w-[20px] min-h-[20px] cursor-pointer"
                                        onClick={() => {
                                            setIsFAQOpen(false);
                                            setIsHelpPageOpen(false);
                                            setOpenFAQIndex(null);
                                        }}
                                    />
                                    <p className="text-[#000000] font-semibold grow text-center mr-[20px]">
                                        {t('faq')}
                                    </p>
                                </div>

                                <div className="flex flex-col mt-5 px-5 pb-5">
                                    {homeFAQs.map((FAQ, index) => (
                                        <div key={"FAQ-" + index}>
                                            <div
                                                className="flex items-center text-[#000000] text-[12px] rounded-[30px] cursor-pointer border border-[#2E5BFF47] py-[0.5rem] px-[1rem]"
                                                onClick={() => handleFAQClick("FAQ-" + index)}
                                            >
                                                <p className="w-full">{FAQ.question}</p>
                                                <FaChevronDown
                                                    className={`${openFAQIndex === "FAQ-" + index ? "rotate-180" : ""
                                                        } transition-transform`}
                                                />
                                            </div>
                                            <div
                                                className={`${openFAQIndex === "FAQ-" + index
                                                        ? "max-h-fit py-[1rem] px-[1rem] border border-[#2E5BFF47] mb-3"
                                                        : "max-h-0 p-0 border-0"
                                                    } transition-all duration-300 overflow-hidden mt-2 items-center bg-[#2E5BFF] text-white shadow-xl text-[12px] rounded-[18px] cursor-pointer`}
                                            >
                                                <p>{FAQ.answer}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Help Panel */}
                            <div
                                className={`noscroll !duration-600 z-30 absolute flex-col bg-white top-0 left-1/2 -translate-x-1/2 overflow-auto min-w-full ${isHelpPageOpen ? "h-full grow flex" : "h-0 grow-0"
                                    }`}
                            >
                                <div className="flex items-center px-5 pt-5">
                                    <IoIosArrowBack
                                        className="text-xl text-[#000000] min-w-[20px] min-h-[20px] cursor-pointer"
                                        onClick={() => {
                                            setIsHelpPageOpen(false);
                                            setIsFAQOpen(false);
                                            setHelpPageIndex(null);
                                        }}
                                    />
                                    <p className="text-[#000000] font-semibold grow text-center mr-[20px]">
                                        {t('needhelp')}
                                    </p>
                                </div>
                                <div className="flex flex-col mt-5 px-5 pb-5">
                                    {helpFAQs.map((help, index) => (
                                        <div key={"Help-" + index}>
                                            <div
                                                className="flex items-center text-[#000000] text-[12px] rounded-[30px] cursor-pointer border border-[#2E5BFF47] py-[0.5rem] px-[1rem]"
                                                onClick={() => handleHelpTabClick("Help-" + index)}
                                            >
                                                <p className="w-full">{help.question}</p>
                                                <FaChevronDown
                                                    className={`${openHelpPageIndex === "Help-" + index
                                                            ? "rotate-180"
                                                            : ""
                                                        } transition-transform`}
                                                />
                                            </div>
                                            <div
                                                className={`${openHelpPageIndex === "Help-" + index
                                                        ? "max-h-fit py-[1rem] px-[1rem] border border-[#2E5BFF47] mb-3"
                                                        : "max-h-0 p-0 border-0"
                                                    } transition-all duration-300 overflow-hidden mt-2 items-center bg-[#2E5BFF] text-white shadow-xl text-[12px] rounded-[18px] cursor-pointer`}
                                            >
                                                <p>{help.answer}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Welcome Screen */}
                            <div
                                className={`${isChatStarted || isFAQOpen || isHelpPageOpen
                                        ? "opacity-0"
                                        : "opacity-100"
                                    } z-10 !duration-[1s] delay-200 grow flex flex-col items-center justify-center`}
                            >
                                <p className="text-[17px] text-center font-semibold text-[#2E5BFF]">
                                    {t("wtm")}
                                </p>
                                <p className="mt-2 text-[13px] text-center text-black">
                                 {t('waamt1cspagcicp')}
                                        
                                </p>
                            </div>

                            {/* Chat Body */}
                            <div
                                className={`!duration-[1s] z-20 absolute flex-col bg-white bottom-0 left-1/2 -translate-x-1/2 min-w-full ${isChatStarted ? "h-full grow flex" : "h-0 grow-0"
                                    }`}
                            >
                                <div className="noscroll chat-body flex flex-col px-5 pt-4 overflow-auto">
                                    {messages.map((message, index) => (
                                        <div
                                            key={"Message-" + index}
                                            className={`mb-3 ${message.sender === "user" ? "self-end" : "self-start"
                                                } ${message.isButton ? "w-full" : "w-fit"}`}
                                        >
                                            <div
                                                className={`px-3 flex animate__animated flex-col py-2 rounded-[20px] break-words text-sm ${message.sender === "user"
                                                        ? "bg-[#E0E0E0] text-black rounded-br-none animate__fadeInRight"
                                                        : "bg-[#F9F9F9] text-black rounded-bl-none animate__fadeInLeft"
                                                    } ${message.isButton ? "w-full" : "w-fit"}`}
                                            >
                                                {!message.isButton && <Markdown>{message.text}</Markdown>}

                                                {message.isButton && (
                                                    <button
                                                        className="mt-2 px-5 py-3 w-full block bg-gradient-to-r from-green-200 to-green-300 text-black rounded-lg shadow-md hover:from-green-300 hover:to-green-400 transition-all duration-300 transform hover:scale-105"
                                                        onClick={() => handleSelection(message.actionType)}
                                                    >
                                                        {message.text}
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                    {sender ? (
                                        <PulseLoader color="#000000" size={10} className="mb-3" />
                                    ) : null}
                                </div>
                            </div>
                        </div>

                        {/* Input Section */}
                        <div
                            className={`${isFAQOpen || isHelpPageOpen || showUserForm
                                    ? "!translate-y-[120px] !h-0"
                                    : "!translate-y-0 h-[120px]"
                                } !duration-[1s] overflow-hidden w-full ${isChatStarted ? "px-0 h-fit" : "px-[20px]"
                                } flex flex-col items-center justify-center`}
                        >
                            <div
                                className={`border w-full flex items-center justify-center py-[0.6rem] gap-3 px-[1rem] border-[#EBECED] ${isChatStarted ? "rounded-t-[18px]" : "rounded-[18px]"
                                    }`}
                            >
                                {/* Mic */}
                                <button
                                    onClick={handleVoiceInput}
                                    className={`rounded-full flex justify-center items-center ${isListening ? "bg-red-500" : "bg-[#2E5BFF]"
                                        } w-[40px] h-[35px] cursor-pointer shadow-md`}
                                >
                                    <FaMicrophone className="text-white text-[16px]" />
                                </button>

                                {/* Input */}
                                <input
                                    type="text"
                                    onFocus={() => {
                                        // if (!isChatStarted) {
                                        //     setShowUserForm(true);
                                        // }
                                    }}
                                    onChange={(e) => setInput(e.target.value)}
                                    value={input}
                                    onKeyDown={(e) => {
                                        if (e.key === "Enter") handleSendMessage();
                                    }}
                                    className="grow focus:outline-none border-none px-3 text-[14px]"
                                    placeholder={t('wcihyw')}
                                />

                                {/* Send */}
                                <button
                                    className={`rounded-full flex justify-center items-center transition-transform duration-200 ${input.trim().length === 0
                                            ? "bg-[#F0F0F0]"
                                            : "bg-[#2E5BFF]"
                                        } w-[40px] h-[35px] cursor-pointer shadow-md hover:scale-110 active:scale-90`}
                                    onClick={handleSendMessage}
                                >
                                    <img
                                        className="w-[16px] h-[16px]"
                                        src={SendImage}
                                        alt="Send"
                                    />
                                </button>
                            </div>

                            {/* Quick Links */}
                            <div
                                className={`${isChatStarted ? "translate-y-[100px] h-0" : "translate-y-0 h-[30px] mt-[10px]"
                                    } !duration-[1s] noscroll w-full overflow-x-auto flex flex-nowrap gap-x-[6px] rounded-[15px]`}
                            >
                                <a
                                    href="https://onmeridian.com/about-us/"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="text-black cursor-pointer whitespace-nowrap text-center border border-[#D1D5DB] bg-[#F3F4F6] hover:bg-[#E5E7EB] text-[13px] font-medium rounded-[15px] py-[0.3rem] px-[0.8rem]"
                                >
                                    {t("aboutus")}
                                </a>
                                <a
                                    href="http://onmeridian.com/meridian-solutions-our-people/"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="text-black cursor-pointer whitespace-nowrap text-center border border-[#D1D5DB] bg-[#F3F4F6] hover:bg-[#E5E7EB] text-[13px] font-medium rounded-[15px] py-[0.3rem] px-[0.8rem]"
                                >
                                    {t("ourteam")}
                                </a>
                                <a
                                    href="https://onmeridian.com/insights/"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="text-black cursor-pointer whitespace-nowrap text-center border border-[#D1D5DB] bg-[#F3F4F6] hover:bg-[#E5E7EB] text-[13px] font-medium rounded-[15px] py-[0.3rem] px-[0.8rem]"
                                >
                                    {t("insights")}
                                </a>
                                <a
                                    href="https://onmeridian.com/careers/"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="text-black cursor-pointer whitespace-nowrap text-center border border-[#D1D5DB] bg-[#F3F4F6] hover:bg-[#E5E7EB] text-[13px] font-medium rounded-[15px] py-[0.3rem] px-[0.8rem]"
                                >
                                    {t("careers")}
                                </a>
                            </div>
                        </div>
                    </>
                ) : (
                    <BsRobot
                        onClick={() => setIsChatbotOpen(true)}
                        className="text-white text-[32px] mb-1"
                    />
                )}
            </div>
        </>

    )
}
export default App;
